<?xml version="1.0" encoding="UTF-8"?>
<cfsSimulation xmlns="http://www.cfs++.org/simulation" 
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
  xsi:schemaLocation="http://www.cfs++.org/simulation 
  https://opencfs.gitlab.io/cfs/xml/CFS-Simulation/CFS.xsd">
  <fileFormats>
    <output>
      <hdf5 directory="."/>
      <info/>
    </output>
    <materialData file="mat.xml" format="xml" />
  </fileFormats>

  <domain geometryType="plane">
    <regionList>
      <region material="99lines" name="mech" />
    </regionList>
  </domain>

  <sequenceStep index="1">
    <analysis>
      <static/>
    </analysis>

    <pdeList>
      <mechanic subType="planeStress">
        <regionList>
          <region name="mech" />
        </regionList>

        <bcsAndLoads>
           <fix name="bottom_left"> 
              <comp dof="x"/> 
              <comp dof="y"/> 
           </fix>
           <fix name="bottom_right"> 
              <comp dof="x"/> 
              <comp dof="y"/> 
           </fix>
           <force name="top">
             <comp dof="y" value="-1"/>
           </force>
        </bcsAndLoads>

        <storeResults>
          <nodeResult type="mechDisplacement">
            <allRegions/>
          </nodeResult>
          <elemResult type="mechPseudoDensity">
            <allRegions/>
          </elemResult>
          <elemResult type="physicalPseudoDensity">
            <allRegions/>
          </elemResult>
          <elemResult type="optResult_1">
            <allRegions/>
          </elemResult>
        </storeResults>
      </mechanic>
    </pdeList>

<!--    <linearSystems> -->
<!--       <system> -->
<!--         <solverList> -->
<!--           <cholmod/> -->
<!--         </solverList> -->
<!--       </system> -->
<!--     </linearSystems>  -->

  </sequenceStep>

  <optimization>
    <costFunction type="compliance" task="minimize">
      <stopping value="0.01" type="belowFunction" function="physical_greyness" condition="necessary" />
      <stopping value="1e-3" type="relativeCostChange" queue="1" condition="necessary" />    
    </costFunction>

    <constraint type="volume" access="filtered" value=".5" bound="upperBound" mode="constraint" linear="false"/>
    <constraint type="volume" access="physical" mode="observation" />
    <constraint type="greyness" access="physical" mode="observation" />

    
    <optimizer type="ocm" maxIterations="400">
      <ocm move_limit="tuned"/>
    </optimizer>

    <ersatzMaterial region="mech" material="mechanic" method="simp" >
      <!-- comment the filter when using slope constraints -->
      <filters>
        <filter neighborhood="maxEdge" value="1.7" type="density">
          <density type="solid_heaviside" beta="tune">
            <tune method="obj" start="1" end="128" stopping_greyness="true"/>
          </density>
        </filter>
      </filters>

      <design name="density" initial=".5" physical_lower="1e-9" upper="1.0"/> 

      <transferFunction type="simp" application="mech" param="3"/>
      
      <!-- Writes the compliance gradient to the .cfs file -->
      <result value="costGradient" id="optResult_1"/>
      <export save="last" write="iteration"/>
    </ersatzMaterial>
    <!-- setting to a larger stride (e.g. 99) writes only every n-th iteration. -->
    <commit mode="each_forward" stride="1"/>
  </optimization>
</cfsSimulation>
